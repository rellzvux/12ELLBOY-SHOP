<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>12ELLBOY — TopUp (User & Admin)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#071426;
    --panel:#071425;
    --card:#0f2130;
    --muted:#9aa4b2;
    --primary:#1DA1F2;
    --accent:#42a5f5;
    --accent2:#2196f3;
    --success:#00cc66;
    --danger:#ff6b6b;
    --radius:14px;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#041018,var(--bg));color:#e6eef8;-webkit-font-smoothing:antialiased;font-size:14px}
  a{color:inherit;text-decoration:none}

  /* Header */
  header{position:sticky;top:0;z-index:120;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(90deg,#061523,#071426);border-bottom:1px solid rgba(255,255,255,0.02)}
  .left{display:flex;align-items:center;gap:12px}
  .logoBox{width:64px;height:64px;border-radius:12px;padding:6px;background:linear-gradient(135deg,#071432,#0b2630);display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
  .logoBox img{width:100%;height:100%;object-fit:cover;display:block;animation:logoLoop 3.6s ease-in-out infinite}
  @keyframes logoLoop{0%{transform:scale(.95) translateX(0);opacity:.95}50%{transform:scale(1.25) translateX(-8px);opacity:1}100%{transform:scale(.95) translateX(0);opacity:.95}}
  .brand{font-weight:800;font-size:18px;display:flex;align-items:center;gap:10px}
  .verified{width:34px;height:34px;border-radius:999px;background:linear-gradient(180deg,var(--primary),#137fcf);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:14px;box-shadow:0 10px 30px rgba(29,161,242,0.12);animation:verPulse 3.6s infinite}
  @keyframes verPulse{0%{transform:rotate(0) scale(.98)}50%{transform:rotate(8deg) scale(1.04)}100%{transform:rotate(0) scale(.98)}}

  /* controls */
  .controls{display:flex;align-items:center;gap:12px}
  .hamburger{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.02);cursor:pointer;z-index:140}
  .bars{width:24px;height:16px;position:relative}
  .bars span{position:absolute;height:2px;width:100%;background:#fff;border-radius:2px;left:0;transition:all .25s}
  .bars span:nth-child(1){top:0} .bars span:nth-child(2){top:7px} .bars span:nth-child(3){top:14px}
  .hamburger.active .bars span:nth-child(1){transform:translateY(7px) rotate(45deg)}
  .hamburger.active .bars span:nth-child(2){opacity:0}
  .hamburger.active .bars span:nth-child(3){transform:translateY(-7px) rotate(-45deg)}

  /* Sidebar */
  .sidebar{position:fixed;right:-360px;top:0;width:320px;height:100%;background:#fff;color:#071021;padding:18px;transition:right .28s;z-index:400;border-left:1px solid rgba(0,0,0,0.06)}
  .sidebar.open{right:0}
  .sidebar h3{margin-top:0;color:#071021}
  .sidebar .menu{display:flex;flex-direction:column;gap:6px}
  .sidebar .menu button{background:transparent;border:none;text-align:left;padding:12px;border-radius:8px;font-weight:700;color:#071021;cursor:pointer}
  .sidebar .menu button:hover{background:rgba(0,0,0,0.04)}
  .sidebar .bottom{position:absolute;left:18px;bottom:18px;width:calc(100% - 36px);display:flex;justify-content:center;align-items:center}
  .apLogo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#42a5f5,#1e88e5);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;cursor:pointer}

  /* Layout for main & admin panel slide */
  .viewport{max-width:980px;margin:18px auto;padding:0 16px;position:relative;transition:filter .28s}
  .heroList{display:grid;gap:14px}
  .cardLarge{border-radius:18px;overflow:hidden;min-height:140px;background:#071426;border:1px solid rgba(255,255,255,0.02);display:flex;align-items:flex-end;padding:18px;color:#fff;background-size:cover;background-position:center;box-shadow:0 10px 40px rgba(2,6,23,0.5)}
  .cardLarge .title{font-size:22px;font-weight:900;text-shadow:0 6px 24px rgba(0,0,0,0.6)}

  /* modal-like transaksi */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:700;justify-content:center;align-items:center}
  .modal .card{background:linear-gradient(180deg,#071425,#061018);border-radius:12px;padding:18px;width:90%;max-width:420px;color:#e6eef8}

  /* qris popup */
  .qrisBox{background:#fff;padding:16px;border-radius:12px;color:#071021;text-align:center}

  /* Admin slide panel (hidden off-canvas right) */
  .adminPanel{position:fixed;right:-110%;top:0;width:100%;max-width:980px;height:100%;background:linear-gradient(180deg,#041018,#071425);box-shadow:-40px 0 80px rgba(1,6,20,0.6);transition:right .45s cubic-bezier(.2,.9,.2,1);z-index:900;overflow:auto}
  .adminPanel.open{right:0}
  .adminHeader{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid rgba(255,255,255,0.03)}
  .adminContent{padding:20px;display:grid;grid-template-columns:1fr 320px;gap:18px}
  @media(max-width:880px){ .adminContent{grid-template-columns:1fr} }

  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .input, select {width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6eef8;margin-top:8px}
  .btn{padding:8px 12px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#041020;font-weight:800;cursor:pointer}
  .small{font-size:13px;color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}

  /* small helpers */
  .row{display:flex;gap:8px;align-items:center}
  .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-weight:700}
</style>
</head>
<body>

<!-- Header -->
<header>
  <div class="left">
    <div class="logoBox"><img id="mainLogo" src="https://i.ibb.co/k8mYZ6y/obito-sketch.png" alt="logo"></div>
    <div class="brand">12ELLBOY <div style="margin-left:6px" class="verified">✔</div></div>
  </div>
  <div class="controls">
    <div id="userArea" class="small"></div>
    <div id="hamburger" class="hamburger" title="Menu" role="button"><div class="bars"><span></span><span></span><span></span></div></div>
  </div>
</header>

<!-- Sidebar -->
<aside id="sidebar" class="sidebar" aria-hidden="true">
  <h3>Menu</h3>
  <div class="menu">
    <button id="homeBtn">Home</button>
    <button id="historyBtn">Riwayat</button>
    <button id="contactBtn">Contact</button>
    <button id="loginGoogleBtn">Login Google</button>
  </div>
  <div class="bottom">
    <!-- Admin entry hidden as AP logo -->
    <div id="apEntry" class="apLogo" title="Admin Panel">AP</div>
  </div>
</aside>

<!-- Main viewport (user) -->
<div id="viewport" class="viewport">
  <section id="mainSection">
    <div id="heroList" class="heroList"></div>
    <div style="max-width:980px;margin:18px auto;padding:16px;color:var(--muted);text-align:center">Website ini aman 100% — verifikasi by Meta ✔</div>
  </section>
</div>

<!-- Transaksi Modal -->
<div id="transModal" class="modal" aria-hidden="true">
  <div class="card">
    <button id="closeTrans" style="float:right;background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer">✖</button>
    <h3 id="transTitle">Top Up</h3>
    <div id="transForm"></div>
  </div>
</div>

<!-- QRIS Popup -->
<div id="qrisModal" class="modal" aria-hidden="true">
  <div class="qrisBox">
    <button id="closeQris" style="position:absolute;right:14px;top:14px;background:none;border:none;font-size:18px;color:#071021;cursor:pointer">✖</button>
    <h3>Scan QRIS</h3>
    <div id="qrisImg" style="margin:12px 0"></div>
    <div style="font-size:13px;color:#333">Bayar sesuai nominal. Jika tidak maka pesanan akan dihanguskan.</div>
    <div style="margin-top:12px"><button id="confirmPaid" class="btn" style="background:var(--success);color:#fff">Saya Sudah Bayar</button></div>
  </div>
</div>

<!-- Admin Panel (slide right) -->
<aside id="adminPanel" class="adminPanel" aria-hidden="true">
  <div class="adminHeader">
    <div>
      <div style="font-weight:900;font-size:18px">Admin Panel — 12ELLBOY</div>
      <div class="small">Kelola game, paket, promo & order</div>
    </div>
    <div>
      <button id="adminBack" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.04);color:#fff;margin-right:8px">⬅ Kembali</button>
      <button id="adminLogout" class="btn">Logout</button>
    </div>
  </div>

  <div class="adminContent">
    <div>
      <div class="card" style="margin-bottom:12px">
        <h3>Kelola Games</h3>
        <div class="row" style="margin-top:8px">
          <input id="newGameName" class="input" placeholder="Nama game (ex: Free Fire)">
          <input id="newGameFile" type="file" accept="image/*">
          <button id="addGameBtn" class="btn">Tambah</button>
        </div>
        <div style="margin-top:10px"><ul id="gamesAdminList"></ul></div>
      </div>

      <div class="card" style="margin-bottom:12px">
        <h3>Tambah Paket (Nominal)</h3>
        <div class="row" style="margin-top:8px">
          <select id="selectGameForNom" class="input"></select>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="pkgName" class="input" placeholder="Nama paket (ex: 50 Diamonds)">
          <input id="pkgPrice" class="input" placeholder="Harga (angka)" type="number">
          <button id="addPkgBtn" class="btn">Tambah</button>
        </div>
        <div style="margin-top:10px"><ul id="pkgAdminList"></ul></div>
      </div>

      <div class="card">
        <h3>Promo Code</h3>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="promoCode" class="input" placeholder="KODE">
          <input id="promoPercent" class="input" placeholder="% Diskon" type="number">
          <button id="addPromoBtn" class="btn">Tambah</button>
        </div>
        <div style="margin-top:10px"><ul id="promoAdminList"></ul></div>
      </div>
    </div>

    <div>
      <div class="card" style="margin-bottom:12px">
        <h3>Assets</h3>
        <div style="display:flex;flex-direction:column;gap:8px">
          <label class="small">Upload Logo Header (PNG/JPG)</label>
          <input id="logoUpload" type="file" accept="image/*">
          <label class="small">Upload QRIS</label>
          <input id="qrisUpload" type="file" accept="image/*">
          <button id="saveAssetsBtn" class="btn">Simpan Assets</button>
        </div>
      </div>

      <div class="card" style="margin-bottom:12px">
        <h3>Order Stats</h3>
        <table><thead><tr><th>#</th><th>Game</th><th>Account</th><th>Item</th><th>Total</th><th>Status</th><th>Time</th></tr></thead><tbody id="ordersAdminTable"></tbody></table>
      </div>

      <div class="card">
        <h3>Tools</h3>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button id="clearLocal" class="btn" style="background:var(--danger)">Clear All Local Data</button>
          <button id="exportState" class="btn">Export State JSON</button>
          <a id="downloadLink" style="display:none"></a>
        </div>
      </div>
    </div>
  </div>
</aside>

<script>
/* ---------------------------
   Data model in localStorage:
   - 12ell_state: { games:[], products:[], promos:[], qris: base64, logo: base64 }
   - 12ell_orders: array of orders (userId nullable)
   - 12ell_user: user object when logged in (simulated Google)
   --------------------------- */

const ADMIN_PASSWORD = 'rellznotboy';

// ensure initial state
function loadState(){ return JSON.parse(localStorage.getItem('12ell_state')||'null') || null; }
function saveState(s){ localStorage.setItem('12ell_state', JSON.stringify(s)); }
let state = loadState();
if(!state){
  state = {
    games:[
      {id:1,name:'Mobile Legends',img:'https://images.unsplash.com/photo-1601758123927-0b7a6b1d7b7e?auto=format&fit=crop&w=1400&q=80'},
      {id:2,name:'Free Fire',img:'https://images.unsplash.com/photo-1545134471-6f1f30a0d9d7?auto=format&fit=crop&w=1400&q=80'},
      {id:3,name:'Roblox',img:'https://images.unsplash.com/photo-1558980664-10d1e04dd6d8?auto=format&fit=crop&w=1400&q=80'}
    ],
    products:[], // {id,gameId,name,price}
    promos:[ {id:Date.now(),code:'WELCOME10',percent:10} ],
    qris:null,
    logo:null
  };
  saveState(state);
}

// helper
function uid(){ return Date.now() + Math.floor(Math.random()*999); }
function toBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

/* ---------------------------
   Render user hero list
   --------------------------- */
const heroList = document.getElementById('heroList');
function renderHero(){
  heroList.innerHTML='';
  state.games.forEach(g=>{
    const d = document.createElement('div');
    d.className='cardLarge';
    d.style.backgroundImage = `url('${g.img || ''}')`;
    d.innerHTML = `<div class="title">${g.name}</div>`;
    d.addEventListener('click', ()=> openTrans(g.id));
    heroList.appendChild(d);
  });
  // set logo if uploaded
  if(state.logo) document.getElementById('mainLogo').src = state.logo;
}
renderHero();

/* ---------------------------
   Sidebar toggle + buttons
   --------------------------- */
const hamburger = document.getElementById('hamburger');
const sidebar = document.getElementById('sidebar');
hamburger.addEventListener('click', ()=>{
  const open = sidebar.classList.toggle('open');
  hamburger.classList.toggle('active', open);
});
document.getElementById('homeBtn').addEventListener('click', ()=>{ window.scrollTo({top:0,behavior:'smooth'}); sidebar.classList.remove('open'); hamburger.classList.remove('active'); });
document.getElementById('contactBtn').addEventListener('click', ()=>{ window.open('https://wa.me/6282186825619','_blank'); sidebar.classList.remove('open'); hamburger.classList.remove('active'); });

/* Login Google simulated */
document.getElementById('loginGoogleBtn').addEventListener('click', ()=>{
  const name = prompt('Login (simulasi) — masukkan nama:');
  if(!name) return;
  const user = { id: Date.now(), name, email: (name.replace(/\s+/g,'').toLowerCase()+'@example.com') };
  localStorage.setItem('12ell_user', JSON.stringify(user));
  document.getElementById('userArea').textContent = `👋 ${user.name}`;
  sidebar.classList.remove('open'); hamburger.classList.remove('active');
});

/* history button shows simple list (or alert if none) */
document.getElementById('historyBtn').addEventListener('click', ()=>{
  const user = JSON.parse(localStorage.getItem('12ell_user')||'null');
  sidebar.classList.remove('open'); hamburger.classList.remove('active');
  if(!user){ alert('Silakan login dulu via Login Google.'); return; }
  const orders = JSON.parse(localStorage.getItem('12ell_orders')||'[]');
  const mine = orders.filter(o=>o.userId === user.id);
  if(mine.length===0){ alert('Belum ada riwayat.'); return; }
  let s = 'Riwayat Anda:\\n\\n';
  mine.forEach(o=> s += `${o.time} • ${o.game} • ${o.item} • ${o.total} • ${o.status}\\n`);
  alert(s);
});

/* Admin entry (AP logo at bottom) — prompts for password then slides admin panel */
const apEntry = document.getElementById('apEntry');
const adminPanel = document.getElementById('adminPanel');
const viewport = document.getElementById('viewport');
apEntry.addEventListener('click', async ()=>{
  sidebar.classList.remove('open'); hamburger.classList.remove('active');
  const pass = prompt('Masukkan password admin:');
  if(pass === ADMIN_PASSWORD){
    openAdminPanel();
  } else {
    alert('Password salah');
  }
});

/* ---------------------------
   Admin panel show/hide with slide
   --------------------------- */
function openAdminPanel(){
  adminPanel.classList.add('open');
  // small blur effect on main viewport
  viewport.style.filter = 'blur(4px) brightness(.8)';
  // init admin views
  renderAdminGames();
  renderAdminPacks();
  renderAdminPromos();
  renderAdminOrders();
  populateGameSelect();
}
function closeAdminPanel(){
  adminPanel.classList.remove('open');
  viewport.style.filter = '';
}
document.getElementById('adminBack').addEventListener('click', closeAdminPanel);
document.getElementById('adminLogout').addEventListener('click', ()=>{ if(confirm('Logout admin?')) closeAdminPanel(); });

/* ---------------------------
   Transaksi (user) flow
   --------------------------- */
const transModal = document.getElementById('transModal');
const transForm = document.getElementById('transForm');
let currentGame = null;
let selectedProduct = null;

function openTrans(gameId){
  currentGame = state.games.find(g=>g.id===gameId);
  document.getElementById('transTitle').textContent = 'Top Up — ' + currentGame.name;
  transForm.innerHTML = '';
  const user = JSON.parse(localStorage.getItem('12ell_user')||'null');
  if(user) transForm.insertAdjacentHTML('beforeend', `<div class="small">Pembeli: ${user.name}</div>`);
  else transForm.insertAdjacentHTML('beforeend', `<div class="small">Silakan login untuk menyimpan riwayat</div>`);
  if(currentGame.name.toLowerCase().includes('roblox')){
    transForm.insertAdjacentHTML('beforeend', `<label class="small">Username</label><input id="usn" class="input"><label class="small">Password</label><input id="pw" class="input" type="password">`);
  } else {
    transForm.insertAdjacentHTML('beforeend', `<label class="small">UID</label><input id="uid" class="input">`);
  }
  // list packages (from state.products)
  const packs = (state.products||[]).filter(p=>p.gameId===gameId);
  let packHtml = '<div style="margin-top:10px"><strong>Pilih Nominal</strong><div id="packWrap" style="display:flex;flex-direction:column;gap:8px;margin-top:8px"></div></div>';
  transForm.insertAdjacentHTML('beforeend', packHtml);
  const packWrap = transForm.querySelector('#packWrap');
  if(packs.length===0){
    // show defaults
    const defaultPacks=[{name:'50 Diamonds',price:14500},{name:'113 Diamonds',price:30300},{name:'170 Diamonds',price:45000}];
    defaultPacks.forEach(p=> addPackCard(packWrap,p));
  } else {
    packs.forEach(p=> addPackCard(packWrap,p));
  }
  transForm.insertAdjacentHTML('beforeend', `<div style="margin-top:10px"><input id="promoInput" class="input" placeholder="Kode promo (opsional)"></div>`);
  transForm.insertAdjacentHTML('beforeend', `<div style="margin-top:10px"><select id="payMethod" class="input"><option value="qris">QRIS (Disarankan)</option><option value="manual">Transfer Manual</option></select></div>`);
  transForm.insertAdjacentHTML('beforeend', `<button id="doPay" class="btn" style="width:100%;margin-top:12px">Bayar</button>`);
  document.getElementById('doPay').addEventListener('click', onDoPay);
  transModal.style.display = 'flex';
}
function addPackCard(container,item){
  const d = document.createElement('div'); d.style.padding='10px'; d.style.borderRadius='8px'; d.style.background='linear-gradient(90deg,#071a2a,#061724)'; d.style.display='flex'; d.style.justifyContent='space-between'; d.style.alignItems='center'; d.style.cursor='pointer';
  d.innerHTML = `<div><div style="font-weight:800">${item.name}</div><div class="small">${item.sub||''}</div></div><div style="text-align:right;font-weight:900">Rp ${Number(item.price).toLocaleString('id-ID')}</div>`;
  d.addEventListener('click', ()=>{ document.querySelectorAll('#packWrap div').forEach(x=>x.style.outline=''); d.style.outline='3px solid rgba(29,161,242,0.16)'; selectedProduct = item; });
  container.appendChild(d);
}
document.getElementById('closeTrans').addEventListener('click', ()=>{ transModal.style.display='none'; selectedProduct=null; });

function onDoPay(){
  if(!selectedProduct){ alert('Pilih paket dulu'); return; }
  const method = document.getElementById('payMethod').value;
  const promoInput = document.getElementById('promoInput').value.trim().toUpperCase();
  const user = JSON.parse(localStorage.getItem('12ell_user')||'null');
  if(!user && !confirm('Belum login. Lanjut sebagai guest?')) return;
  // collect account
  let account = '';
  if(currentGame.name.toLowerCase().includes('roblox')){
    const usn = document.getElementById('usn').value.trim(); const pw = document.getElementById('pw').value.trim();
    if(!usn||!pw){ alert('Isi username & password'); return; }
    account = `${usn} / ${'*'.repeat(Math.min(6,pw.length))}`;
  } else {
    const uid = document.getElementById('uid').value.trim();
    if(!uid){ alert('Isi UID'); return; }
    account = uid;
  }
  // price
  let final = selectedProduct.price;
  if(promoInput){
    const promo = (state.promos||[]).find(pp=>pp.code===promoInput);
    if(promo) final = Math.round(final * (100 - promo.percent)/100);
    else alert('Promo tidak ditemukan (ignored)');
  }
  // store order
  const orders = JSON.parse(localStorage.getItem('12ell_orders')||'[]');
  const order = { id: uid(), game: currentGame.name, account, item: selectedProduct.name, total: `Rp ${Number(final).toLocaleString('id-ID')}`, method, status:'Pending', time: new Date().toLocaleString(), userId: user ? user.id : null };
  orders.unshift(order); localStorage.setItem('12ell_orders', JSON.stringify(orders));
  // show QRIS if needed
  if(method === 'qris'){
    const q = state.qris || localStorage.getItem('12ell_qris');
    if(q){
      document.getElementById('qrisImg').innerHTML = `<img src="${q}" style="max-width:260px;border-radius:8px">`;
    } else {
      document.getElementById('qrisImg').innerHTML = `<div class="small">QRIS belum diupload admin</div>`;
    }
    document.getElementById('qrisModal').style.display = 'flex';
  } else {
    alert('Order tersimpan. Admin akan memproses.');
    transModal.style.display = 'none';
  }
}

/* confirm paid */
document.getElementById('confirmPaid').addEventListener('click', ()=>{
  alert('Terima kasih. Konfirmasi terkirim. Admin akan memverifikasi.');
  document.getElementById('qrisModal').style.display = 'none';
  transModal.style.display = 'none';
});

/* ---------------------------
   Admin panel features
   --------------------------- */

/* render admin games list */
function renderAdminGames(){
  const ul = document.getElementById('gamesAdminList'); ul.innerHTML='';
  state.games.forEach(g=>{
    const li = document.createElement('li'); li.style.display='flex'; li.style.justifyContent='space-between'; li.style.alignItems='center'; li.style.padding='8px 0';
    li.innerHTML = `<div><strong>${g.name}</strong><div class="small">${g.img? 'Gambar terpasang':''}</div></div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn editGame" data-id="${g.id}">Edit</button>
        <button class="btn" style="background:var(--danger);color:#fff" data-id="${g.id}" data-act="del">Hapus</button>
      </div>`;
    ul.appendChild(li);
  });
  // attach actions
  document.querySelectorAll('[data-act="del"]').forEach(b=> b.addEventListener('click', (e)=>{
    const id = Number(e.currentTarget.dataset.id);
    if(!confirm('Hapus game ini?')) return;
    state.games = state.games.filter(x=>x.id !== id);
    // also remove products
    state.products = (state.products||[]).filter(p=>p.gameId !== id);
    saveState(state); renderAdminGames(); renderHero(); populateGameSelect(); renderAdminPacks();
  }));
  document.querySelectorAll('.editGame').forEach(b=> b.addEventListener('click', async (e)=>{
    const id = Number(e.currentTarget.dataset.id);
    const g = state.games.find(x=>x.id===id);
    const newName = prompt('Nama game', g.name);
    if(newName) g.name = newName;
    // change image optional via file selector
    const file = document.createElement('input'); file.type='file'; file.accept='image/*';
    file.onchange = async ev=>{
      const f = ev.target.files[0];
      if(f){ const b = await toBase64(f); g.img = b; saveState(state); renderAdminGames(); renderHero(); }
    };
    file.click();
    saveState(state); renderAdminGames(); renderHero(); populateGameSelect();
  }));
}

/* add game */
document.getElementById('addGameBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('newGameName').value.trim();
  const f = document.getElementById('newGameFile').files[0];
  if(!name) return alert('Isi nama game');
  let b64 = '';
  if(f) b64 = await toBase64(f);
  const g = { id: uid(), name, img: b64 || '' };
  state.games.push(g); saveState(state);
  document.getElementById('newGameName').value=''; document.getElementById('newGameFile').value='';
  renderAdminGames(); renderHero(); populateGameSelect(); renderAdminPacks();
});

/* populate select game for packages */
function populateGameSelect(){
  const sel = document.getElementById('selectGameForNom'); sel.innerHTML='';
  state.games.forEach(g=>{ const o = document.createElement('option'); o.value = g.id; o.textContent = g.name; sel.appendChild(o); });
}

/* add package (nominal) */
document.getElementById('addPkgBtn').addEventListener('click', ()=>{
  const gid = Number(document.getElementById('selectGameForNom').value);
  const name = document.getElementById('pkgName').value.trim();
  const price = Number(document.getElementById('pkgPrice').value);
  if(!gid||!name||!price) return alert('Lengkapi data paket');
  state.products = state.products||[];
  state.products.push({ id: uid(), gameId: gid, name, price });
  saveState(state);
  document.getElementById('pkgName').value=''; document.getElementById('pkgPrice').value='';
  renderAdminPacks(); renderHero();
});
function renderAdminPacks(){
  const ul = document.getElementById('pkgAdminList'); ul.innerHTML='';
  (state.products||[]).forEach(p=>{
    const g = state.games.find(x=>x.id===p.gameId);
    const li = document.createElement('li'); li.style.display='flex'; li.style.justifyContent='space-between'; li.style.alignItems='center'; li.style.padding='6px 0';
    li.innerHTML = `<div><strong>${p.name}</strong><div class="small">${g?g.name:'-'}</div></div><div style="display:flex;gap:8px;align-items:center"><div class="small">Rp ${Number(p.price).toLocaleString('id-ID')}</div><button class="btn" data-id="${p.id}" style="background:var(--danger);color:#fff">Hapus</button></div>`;
    ul.appendChild(li);
  });
  document.querySelectorAll('#pkgAdminList button[data-id]').forEach(b=> b.addEventListener('click', (e)=>{
    const id = Number(e.currentTarget.dataset.id);
    if(!confirm('Hapus paket?')) return;
    state.products = state.products.filter(x=>x.id!==id);
    saveState(state); renderAdminPacks(); renderHero();
  }));
}

/* promo */
document.getElementById('addPromoBtn').addEventListener('click', ()=>{
  const code = document.getElementById('promoCode').value.trim().toUpperCase();
  const percent = Number(document.getElementById('promoPercent').value);
  if(!code||!percent) return alert('Lengkapi promo');
  state.promos = state.promos || [];
  state.promos.push({ id: uid(), code, percent });
  saveState(state);
  document.getElementById('promoCode').value=''; document.getElementById('promoPercent').value='';
  renderAdminPromos();
});
function renderAdminPromos(){
  const ul = document.getElementById('promoAdminList'); ul.innerHTML='';
  (state.promos||[]).forEach(p=>{
    const li = document.createElement('li'); li.style.padding='6px 0';
    li.innerHTML = `<strong>${p.code}</strong> • ${p.percent}% <button class="btn" data-id="${p.id}" style="background:var(--danger);color:#fff;margin-left:8px">Hapus</button>`;
    ul.appendChild(li);
  });
  document.querySelectorAll('#promoAdminList button[data-id]').forEach(b=> b.addEventListener('click', (e)=>{
    const id = Number(e.currentTarget.dataset.id);
    state.promos = state.promos.filter(x=>x.id!==id); saveState(state); renderAdminPromos();
  }));
}

/* assets save (logo + qris) */
document.getElementById('saveAssetsBtn').addEventListener('click', async ()=>{
  const logF = document.getElementById('logoUpload').files[0];
  const qF = document.getElementById('qrisUpload').files[0];
  if(logF){
    const b = await toBase64(logF); state.logo = b;
  }
  if(qF){
    const b2 = await toBase64(qF); state.qris = b2;
  }
  saveState(state);
  alert('Assets tersimpan');
  renderHero();
});

/* render orders for admin */
function renderAdminOrders(){
  const tbody = document.getElementById('ordersAdminTable'); tbody.innerHTML='';
  const orders = JSON.parse(localStorage.getItem('12ell_orders')||'[]');
  orders.forEach((o,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${o.game}</td><td>${o.account || '-'}</td><td>${o.item}</td><td>${o.total}</td><td>${o.status}</td><td>${o.time}</td>`;
    tbody.appendChild(tr);
  });
}
function renderAdminOrdersDeferred(){ renderAdminOrders(); }

/* tools */
document.getElementById('clearLocal').addEventListener('click', ()=>{
  if(!confirm('Hapus semua data local (termasuk orders & state)?')) return;
  localStorage.clear();
  alert('LocalStorage dibersihkan. Halaman akan reload.');
  location.reload();
});
document.getElementById('exportState').addEventListener('click', ()=>{
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.getElementById('downloadLink');
  a.href = url; a.download = '12ell_state.json'; a.click();
  URL.revokeObjectURL(url);
});

/* populate selects & initial renders for admin when opened */
function populateInitialAdmin(){
  populateGameSelect();
  renderAdminGames();
  renderAdminPacks();
  renderAdminPromos();
  renderAdminOrdersDeferred();
}
populateInitialAdmin();

/* re-render admin orders when admin panel opens */
const obs = new MutationObserver(()=>{ if(adminPanel.classList.contains('open')) renderAdminOrders(); });
obs.observe(adminPanel, { attributes: true, attributeFilter: ['class'] });

/* render hero again in case logo uploaded */
if(state.logo) document.getElementById('mainLogo').src = state.logo;

/* close modals on Escape */
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ document.getElementById('transModal').style.display='none'; document.getElementById('qrisModal').style.display='none'; if(sidebar.classList.contains('open')){ sidebar.classList.remove('open'); hamburger.classList.remove('active'); } } });

/* ensure admin panel shows latest state after changes */
function renderAdminPacks(){ renderAdminPacks = renderAdminPacks; /* placeholder to ensure function exists earlier */ }
</script>
</body>
</html>